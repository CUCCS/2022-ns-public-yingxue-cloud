# 基于 VirtualBox 的网络攻防基础环境搭建

# 实验目的

+ 掌握 VirtualBox 虚拟机的安装与使用；
+ 掌握 VirtualBox 的虚拟网络类型和按需配置；
+ 掌握 VirtualBox 的虚拟硬盘多重加载；

# 实验环境
以下是本次实验需要使用的网络节点说明和主要软件举例：

+ VirtualBox 虚拟机
+ 攻击者主机（Attacker）：Kali Rolling 2019.2
+ 网关（Gateway, GW）：Debian Buster
+ 靶机（Victim）：From Sqli to shell / xp-sp3 / Kali

# 实验流程

## 一、虚拟硬盘配置成多重加载

+ 打开虚拟机主界面的管理
+ 然后打开虚拟介质管理
+ 选择相应的虚拟硬盘，在属性里将其类型改为多重加载，释放盘片后重新加载即可。另外，在配置多重加载之前，虚拟硬盘需要加载在某个虚拟机上。
![Multi-load configuration](./%E5%9B%BE%E7%89%87/多重加载配置.png)

## 二、搭建满足要求的虚拟机网络拓扑

+ **实验环境**：本次实验需要六台虚拟机，kali、Debian10、Windows XP各两台。一台kali作为攻击者，一台Debian作为网关，剩下四台分布在两个局域网内，均作为靶机。其网络拓扑图如下：

![Network topology diagram](./%E5%9B%BE%E7%89%87/%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91%E5%9B%BE.png)

+ **网络类型**：本次实验需要使用**网络地址转换（NAT）**、**内部网络（Internal）**、**仅主机（Host-only）网络**三种网络类型。它们的特点分别如下

    + 网络地址转换（NAT）：虚拟机可以访问主机，而主机无法访问虚拟机；另外，虚拟机可以访问网络中的其他主机，而其他主机不能访问虚拟机；虚拟机不能访问其他虚拟机。

    + 内部网络（Internal）：虚拟机不可以访问主机，不可以访问网络中的其他主机；可以访问在同一内部网络下的虚拟机，不可以访问其他虚拟机。

    + 仅主机（Host-only）网络：默认情况下，虚拟机不可以访问主机，但通过配置，可以实现虚拟机与主机相互访问；虚拟机与网络中的其他主机同上一条；默认情况下，虚拟机之间可以相互访问。

+ 配置拓扑网络所需的网络环境

    + 网关：NAT网络（使网关可以访问攻击者）、Host-only、两块内部网络（分别用于搭建两块独立的局域网）

    + 攻击者：NAT网络

    + 靶机：均为内部网络，分为两组，使其位于不同的局域网内。其中Victim-XP-1和Victim-Kali-1位于同一个局域网intnet1内，Victim-Debian-2和Victim-XP-2位于同一个局域网intnet2内.Gateway-Debian作为这个网络环境的网关

## 三、完成网络连通性测试

### 实验要求

- [x] 靶机可以直接访问攻击者主机
- [x] 攻击者主机无法直接访问靶机
- [x] 网关可以直接访问攻击者主机和靶机
- [x] 靶机的所有对外上下行流量必须经过网关
- [x] 所有节点均可以访问互联网

### 实验验证

+ 靶机及攻击者的IP地址和子网掩码

| 虚拟机 | IP地址 | 子网掩码 |
| :---- | :---- | :---- |
| Victim-XP-1 | 172.16.111.147 | 255.255.255.0 |
| Victim-XP-2 | 172.16.222.102 | 255.255.255.0 |
| Victim-Kali-1 | 172.16.111.110 | 255.255.255.0 |
| Victim-Debian-2 | 172.16.222.173 | 255.255.255.0 |
| Attacker-Kali-2 | 10.0.2.15 | 255.255.255.0 |

+ 网关的四个网卡对应的IP地址和子网掩码

| 网卡 | IP地址 | 子网掩码 |
| :---- | :---- | :---- |
| 网卡1 | 10.0.2.15 | 255.255.255.0 |
| 网卡2 | 192.168.56.113 | 255.255.255.0 |
| 网卡3 | 172.16.111.1 | 255.255.255.0 |
| 网卡4 | 172.16.222.1 | 255.255.255.0 |

1. 靶机可以直接访问攻击者主机

    + 通过ping攻击者主机，可以观察到有回复，说明网络层是连通的。由此可证明，靶机可以访问攻击者主机

    ![The target machine accesses the attacker](./%E5%9B%BE%E7%89%87/%E9%9D%B6%E6%9C%BA%E5%88%B0%E6%94%BB%E5%87%BB%E8%80%85%E7%9A%84%E8%BF%9E%E9%80%9A%E6%80%A7%E6%B5%8B%E8%AF%95.png)

2. 攻击者主机无法直接访问靶机

    + 通过ping对靶机进行通信，发现数据包无法到达对应靶机。由此可证明，攻击者主机无法直接访问靶机

    ![The attacker accesses the target machine](./%E5%9B%BE%E7%89%87/%E6%94%BB%E5%87%BB%E8%80%85%E8%AE%BF%E9%97%AE%E9%9D%B6%E6%9C%BA.png)

3. 网关可以直接访问攻击者主机和靶机

    + 通过ping分别连接攻击者和靶机，超过连通，说明网关可以直接访问攻击者主机和靶机

    + 网关访问攻击者

    ![The gateway accesses the target machine](./%E5%9B%BE%E7%89%87/%E7%BD%91%E5%85%B3%E8%AE%BF%E9%97%AE%E6%94%BB%E5%87%BB%E8%80%85.png)

    + 网关访问靶机

    ![](./%E5%9B%BE%E7%89%87/%E7%BD%91%E5%85%B3%E8%AE%BF%E9%97%AE%E9%9D%B6%E6%9C%BA.png)

4. 靶机的所有对外上下行流量必须经过网关

    + 若在网关中通过抓包可以抓取靶机所以向外传送的包，就说明靶机的所有对外上下行流量会经过网关。这里网关使用的抓包命令是`tcpdump -i enp0s10 -n`，我抓的为intnet2网络的靶机，因此网关需要抓的是经过enp0s10的流量。

    ![The gateway grabs packets](./%E5%9B%BE%E7%89%87/%E9%9D%B6%E6%9C%BA%E6%B5%81%E9%87%8F%E7%BB%8F%E8%BF%87%E7%BD%91%E5%85%B3.png)

5. 所有节点均可以访问互联网

    + 网关访问互联网

    ![The gateway accesses the Internet](./%E5%9B%BE%E7%89%87/%E7%BD%91%E5%85%B3%E8%AE%BF%E9%97%AE%E4%BA%92%E8%81%94%E7%BD%91.png)

    + 攻击者访问互联网

    ![The attacker accesses the Internet](./%E5%9B%BE%E7%89%87/%E6%94%BB%E5%87%BB%E8%80%85%E8%AE%BF%E9%97%AE%E4%BA%92%E8%81%94%E7%BD%91.png)

    + 靶机访问互联网

    ![The target machine accesses the Internet](./%E5%9B%BE%E7%89%87/%E9%9D%B6%E6%9C%BA%E8%AE%BF%E9%97%AE%E4%BA%92%E8%81%94%E7%BD%91.png)

## 绘制网络拓扑图

![Map the network topology](./%E5%9B%BE%E7%89%87/%E7%BB%98%E5%88%B6%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91%E5%9B%BE.jpg)

## 问题

+ 虚拟硬盘无法修改成多重加载，后来将虚拟硬盘添加到虚拟机后，又可以了。

+ 网关无法访问Windows XP系统，后来发现是未关闭防火墙。

